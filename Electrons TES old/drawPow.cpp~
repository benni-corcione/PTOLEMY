#include <iostream>
#include <fstream>
#include "TFile.h"
#include "TTree.h"
#include "TH2D.h"
#include "TGraphErrors.h"
#include "TCanvas.h"
#include "TPad.h"
#include "TLine.h"
#include "TPaveText.h"
#include "TLegend.h"

#include "common.h"




int main() {


  TStyle* style = setStyle();
  //style->SetPadTickY(0);
  style->cd();


  std::ifstream ifs1 ("data/power1.dat" );
  std::ifstream ifs2 ("data/power2.dat" );

  TGraphErrors* gr_power1 = new TGraphErrors(0);
  TGraphErrors* gr_power2 = new TGraphErrors(0);

  TLegend* legend = new TLegend(0.6,0.2,0.85,0.3);
  legend->SetBorderSize(0);
  legend->SetFillColor(0);
    
  std::vector<int> colors = get_colors();

  gr_power1->SetMarkerStyle(8);
  gr_power1->SetMarkerSize(1.6);
  gr_power1->SetMarkerColor(colors[0]);
  gr_power1->SetLineColor  (colors[0]);
  gr_power2->SetMarkerStyle(8);
  gr_power2->SetMarkerSize(1.6);
  gr_power2->SetMarkerColor(colors[1]);
  gr_power2->SetLineColor  (colors[1]);
  
  int iPoint = 0;
  double v1,i1,r1,p1;
  double v2,i2,r2,p2;
  float norma1 = 0;
  float norma2 = 0;
  //while( !(ifs->eof()) ) {

  while( ifs1 >> v1 >> i1 >> r1 >> p1 ) {

    if(v1==95){norma1=p1*1E+12;}
    gr_power1->SetPoint     ( iPoint, v1, (p1*1E+12)/norma1 ); // in pW
    gr_power1->SetPointError( iPoint, 0., 0.005*p1*1E+12/norma1 ); // in pW
    iPoint++;
      //std::cout << v1 << " " << p1*1E+12 << std::endl;
  }

  iPoint = 0;

  while( ifs2 >> v2 >> i2 >> r2 >> p2 ) {
      
    if(v2==95){norma2=p2*1E+12;}
    gr_power2->SetPoint     ( iPoint, v2, p2*1E+12/norma2 ); // in pW
    gr_power2->SetPointError( iPoint, 0., 0.005*p2*1E+12/norma2 ); // in pW
    iPoint++;

      //std::cout << v2 << " " << p2*1E+12/norma2 << std::endl;
  }
  
  TCanvas* c1 = new TCanvas( "c1", "", 600, 600 );
  c1->cd();

  //TPad *pad_power  = new TPad("pad_power" ,"",0,0,1,1);

  double xmin = 93.;
  double xmax = 112.;

  TH2D *h2_axes_power = new TH2D( "axes_power", "", 10, xmin, xmax, 10, 0 , 1.2  );
  h2_axes_power->SetXTitle( "Nanotube voltage #it{V}_{cnt} (V)" );
  h2_axes_power->SetYTitle( "#it{P}_{J}(#it{V}_{cnt})/#it{P}_{J}(95 V)" );
  h2_axes_power->GetYaxis()->SetTitleOffset(1.2);
  h2_axes_power->GetYaxis()->SetAxisColor (colors[0]);
  h2_axes_power->GetYaxis()->SetTitleColor(colors[0]);
  h2_axes_power->GetYaxis()->SetLabelColor(colors[0]);

  TLine* line_uno = new TLine( xmin, 1, xmax, 1 );
  line_uno->SetLineColor( colors[2] );
  line_uno->SetLineStyle( 7 );
  line_uno->SetLineWidth( 5 );
    
  //pad_power->Draw();
  //pad_power->cd();
  h2_axes_power->Draw("");
  line_uno->Draw("same");
  gr_power1->Draw("psame");
  gr_power2->Draw("psame");
    
  legend->AddEntry(gr_power1, "march 2024", "pe");
  legend->AddEntry(gr_power2, "december 2024", "pe");
  legend->Draw("same");
  c1->SaveAs("power_cfr.pdf");

  return 0;

}
